<template>
  <div class="wrapper">
    <KarrotSlot name="groupWall">
      <template #default>
        <div class="notices">
          <div v-if="joinedActivities.length > 0">
            <JoinedActivities :activities="joinedActivities" />
          </div>
          <div v-if="hasAvailableActivities">
            <AvailableActivities />
          </div>
          <FeedbackNotice
            v-if="feedbackPossibleCount > 0"
            :feedback-possible-count="feedbackPossibleCount"
          />
        </div>
        <WallConversation :group-id="groupId" />
      </template>
      <template #joined-activities>
        <JoinedActivities
          v-if="joinedActivities.length > 0"
          :activities="joinedActivities"
        />
      </template>
      <template #available-activities>
        <AvailableActivities v-if="hasAvailableActivities" />
      </template>
      <template #feedback-notice>
        <FeedbackNotice
          v-if="feedbackPossibleCount > 0"
          :feedback-possible-count="feedbackPossibleCount"
        />
      </template>
      <template #wall>
        <WallConversation :group-id="groupId" />
      </template>
    </KarrotSlot>
  </div>
</template>

<script>
import { computed } from 'vue'

import { useActivityListQuery } from '@/activities/queries'
import { useCurrentGroupService } from '@/group/services'
import { useStatusService } from '@/status/services'
import { newDateRoundedTo5Minutes } from '@/utils/queryHelpers'

import KarrotSlot from '@/base/components/KarrotSlot.vue'
import AvailableActivities from '@/group/components/AvailableActivities.vue'
import FeedbackNotice from '@/group/components/FeedbackNotice.vue'
import JoinedActivities from '@/group/components/JoinedActivities.vue'
import WallConversation from '@/messages/components/WallConversation.vue'

export default {
  components: {
    KarrotSlot,
    JoinedActivities,
    AvailableActivities,
    WallConversation,
    FeedbackNotice,
  },
  setup () {
    const { groupId } = useCurrentGroupService()
    const { getGroupStatus } = useStatusService()

    const {
      activities: joinedActivities,
    } = useActivityListQuery({
      groupId,
      dateMin: newDateRoundedTo5Minutes(),
      slots: 'joined',
      pageSize: 50,
    })

    const {
      activities: availableActivities,
    } = useActivityListQuery({
      groupId,
      dateMin: newDateRoundedTo5Minutes(),
      slots: 'free',
      places: 'subscribed',
      pageSize: 1,
    })

    const hasAvailableActivities = computed(() => availableActivities.value.length > 0)

    const feedbackPossibleCount = computed(() => getGroupStatus(groupId.value).feedbackPossibleCount)

    return {
      groupId,
      joinedActivities,
      hasAvailableActivities,
      feedbackPossibleCount,
    }
  },
}
</script>

<style scoped lang="sass">
.notices
  margin-top: .5em
  margin-bottom: 3em
</style>
