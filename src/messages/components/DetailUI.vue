<template>
  <div class="Detail">
    <KSpinner v-show="pending" />
    <ChatConversation
      v-if="conversation"
      :conversation="conversation"
      :messages="maybeReversedMessages"
      :away="away"
      :current-user="currentUser"
      :start-at-bottom="Boolean(user) || Boolean(activity)"
      :inline="inline"
      compose
      @send="(...args) => $emit('send', ...args)"
      @mark="(...args) => $emit('mark', ...args)"
      @toggle-reaction="(...args) => $emit('toggle-reaction', ...args)"
      @save-message="(...args) => $emit('save-message', ...args)"
      @fetch-past="(...args) => $emit('fetch-past', ...args)"
      @fetch-future="$emit('fetch-future')"
    >
      <template #before-chat-messages>
        <QExpansionItem
          v-if="application"
          default-opened
          class="bg-grey-2"
          :label="$t('APPLICATION.INITIAL')"
          header-class="text-bold"
        >
          <div class="q-pb-sm bg-grey-2">
            <div class="q-ma-sm q-pa-sm bg-white">
              <span class="text-bold text-secondary text-uppercase">{{ application.group.name }}</span>
              <span class="message-date">
                <small class="text-weight-light">
                  <DateAsWords :date="application.createdAt" />
                </small>
              </span>
              <Markdown :source="application.questions" />
            </div>
            <div class="q-ma-sm q-pa-sm bg-white">
              <span class="text-bold text-secondary text-uppercase">{{ application.user.displayName }}</span>
              <span class="message-date">
                <small class="text-weight-light">
                  <DateAsWords :date="application.createdAt" />
                </small>
              </span>
              <Markdown :source="application.answers" />
            </div>
          </div>
        </QExpansionItem>
      </template>
      <template
        v-if="application && application.canDecide"
        #before-chat-compose
      >
        <QBtnGroup
          flat
          spread
          class="bg-grey-2 q-my-sm q-mx-md"
        >
          <QBtn
            flat
            icon="fas fa-fw fa-check"
            color="positive"
            class="q-pa-sm"
            @click="applicationAccept(application)"
          >
            {{ $t('BUTTON.ACCEPT') }}
          </QBtn>
          <QBtn
            flat
            icon="fas fa-fw fa-times"
            color="negative"
            class="q-pa-sm"
            @click="applicationDecline(application)"
          >
            {{ $t('BUTTON.DECLINE') }}
          </QBtn>
        </QBtnGroup>
      </template>
      <template #after-chat-messages>
        <QList
          v-if="activity && activity.isDisabled"
          class="bg-grey-2"
        >
          <QItem>
            <QItemSection>
              <QItemLabel>
                <b class="text-negative">{{ $t('ACTIVITYLIST.ACTIVITY_DISABLED') }}</b>
              </QItemLabel>
            </QItemSection>
          </QItem>
        </QList>
      </template>
    </ChatConversation>
  </div>
</template>

<script>
import ChatConversation from '@/messages/components/ChatConversation'
import Markdown from '@/utils/components/Markdown'
import DateAsWords from '@/utils/components/DateAsWords'
import KSpinner from '@/utils/components/KSpinner'

import {
  QExpansionItem,
  QList,
  QItem,
  QItemSection,
  QItemLabel,
  QBtn,
  QBtnGroup,
  Dialog,
} from 'quasar'

export default {
  components: {
    ChatConversation,
    Markdown,
    DateAsWords,
    KSpinner,
    QExpansionItem,
    QList,
    QItem,
    QItemSection,
    QItemLabel,
    QBtn,
    QBtnGroup,
  },
  props: {
    inline: {
      type: Boolean,
      default: false,
    },
    user: {
      type: Object,
      default: null,
    },
    activity: {
      type: Object,
      default: null,
    },
    application: {
      type: Object,
      default: null,
    },
    conversation: {
      type: Object,
      default: null,
    },
    messages: {
      type: Array,
      default: null,
    },
    pending: {
      type: Boolean,
      default: false,
    },
    away: {
      type: Boolean,
      default: false,
    },
    currentUser: {
      type: Object,
      default: null,
    },
  },
  emits: [
    'send',
    'mark',
    'toggle-reaction',
    'save-message',
    'fetch-past',
    'fetch-future',
    'application-accept',
    'application-decline',
  ],
  computed: {
    maybeReversedMessages () {
      if (!this.conversation || !this.messages) return
      // TODO reverse message on server
      return this.conversation.thread ? this.messages : this.messages.slice().reverse()
    },
  },
  methods: {
    applicationAccept (application) {
      Dialog.create({
        title: this.$t('APPLICATION.ACCEPT_CONFIRMATION_HEADER'),
        message: this.$t('APPLICATION.ACCEPT_CONFIRMATION_TEXT', { userName: application.user.displayName }),
        ok: this.$t('BUTTON.YES'),
        cancel: this.$t('BUTTON.CANCEL'),
      })
        .onOk(() => this.$emit('application-accept', application.id))
    },
    applicationDecline (application) {
      Dialog.create({
        title: this.$t('APPLICATION.DECLINE_CONFIRMATION_HEADER'),
        message: this.$t('APPLICATION.DECLINE_CONFIRMATION_TEXT', { userName: application.user.displayName }),
        ok: this.$t('BUTTON.YES'),
        cancel: this.$t('BUTTON.CANCEL'),
      })
        .onOk(() => this.$emit('application-decline', application.id))
    },
  },
}
</script>

<style scoped lang="sass">
.Detail
  background-color: white

.message-date
  display: inline-block
  margin-left: 2px
</style>
