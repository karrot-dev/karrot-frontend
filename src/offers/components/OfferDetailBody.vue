<template>
  <ChatConversation
    v-if="conversation"
    :conversation="conversationWithReversedMessages"
    :away="away"
    :current-user="currentUser"
    compose
    :inline="inline"
    @mark="mark"
    @toggle-reaction="toggleReaction"
    @save-message="saveMessage"
    @fetch-past="fetchPast"
    @send="send"
  >
    <template
      v-if="offer"
      #before-chat-messages
    >
      <QCarousel
        v-if="offer.images.length > 0"
        v-model="selectedImageIndex"
        v-bind="carouselOptions"
      >
        <QCarouselSlide
          v-for="(image, idx) in offer.images"
          :key="image.id"
          :name="idx"
          :img-src="image.imageUrls['600']"
        />
      </QCarousel>
      <div
        v-if="!isDefaultStatus"
        class="q-pa-md text-center text-h6 text-white bg-negative"
      >
        {{ offer.status }}
      </div>
      <div
        v-if="canEdit && offer.status === 'active'"
        class="row justify-end"
      >
        <QBtnDropdown
          flat
          no-caps
          :label="$t('OFFER.MARK_AS_ARCHIVED')"
        >
          <div
            class="q-pa-lg"
            style="max-width: 300px;"
          >
            <div
              v-t="'OFFER.MARK_AS_ARCHIVED_DESCRIPTION'"
              class="text-body1 q-mb-lg"
            />
            <div class="row justify-end">
              <QBtn
                color="negative"
                @click="archive({ offerId: offer.id })"
              >
                <span v-t="'OFFER.MARK_AS_ARCHIVED'" />
              </QBtn>
            </div>
          </div>
        </QBtnDropdown>
      </div>
      <div class="q-ma-md q-pa-md bg-white grey-border">
        <Markdown
          v-measure
          :source="offer.description"
        />
      </div>
    </template>
  </ChatConversation>
  <KSpinner v-else />
</template>

<script>
import { mapActions, mapGetters } from 'vuex'
import ChatConversation from '@/messages/components/ChatConversation'
import Markdown from '@/utils/components/Markdown'
import KSpinner from '@/utils/components/KSpinner'
import { QBtn, QBtnDropdown, QCarousel, QCarouselSlide } from 'quasar'
import { DEFAULT_STATUS, useCurrentOfferQuery } from '@/offers/queries'
import { useArchiveOfferMutation } from '@/offers/mutations'
import { useAuthService } from '@/authuser/services'

export default {
  components: {
    QBtn,
    QBtnDropdown,
    QCarousel,
    QCarouselSlide,
    ChatConversation,
    Markdown,
    KSpinner,
  },
  props: {
    inline: {
      type: Boolean,
      default: false,
    },
  },
  setup () {
    const { mutate: archive } = useArchiveOfferMutation()
    const { offer } = useCurrentOfferQuery()
    const { user: currentUser } = useAuthService()
    return {
      archive,
      offer,
      currentUser,
    }
  },
  data () {
    return {
      selectedImageIndex: 0,
    }
  },
  computed: {
    ...mapGetters({
      conversation: 'currentOffer/conversation',
      away: 'presence/toggle/away',
    }),
    canEdit () {
      return this.offer.user === this.currentUser?.id
    },
    conversationWithReversedMessages () {
      return {
        ...this.conversation,
        messages: this.conversation.messages.slice().reverse(),
      }
    },
    carouselOptions () {
      if (this.offer.images.length <= 1) return
      return {
        swipeable: true,
        animated: true,
        thumbnails: true,
        arrows: true,
        infinite: true,
      }
    },
    isDefaultStatus () {
      return this.offer.status === DEFAULT_STATUS
    },
  },
  watch: {
    offer () {
      this.selectedImageIndex = 0
    },
  },
  methods: {
    ...mapActions({
      send: 'conversations/send',
      saveMessage: 'conversations/saveMessage',
      mark: 'conversations/maybeMark',
      setMuted: 'conversations/maybeSetMuted',
      toggleReaction: 'conversations/toggleReaction',
      fetchPast: 'conversations/fetchPast',
      saveConversation: 'conversations/maybeSave',
    }),
  },
}
</script>
