<template>
  <div
    class="row justify-start"
    ref="wrapperDiv"
  >
    <QResizeObservable
      style="width: 100%"
      @resize="calculateSlotsPerRow"
    />
    <div
      v-for="user in pickup.collectors"
      v-if="!user.isCurrentUser"
      :key="'collector' + user.id"
      class="relative-position pic-wrapper"
    >
      <div
        v-if="isNewcomer(user)"
        class="newcomer-box"
        :title="$t('USERDATA.NEWCOMER_GUIDANCE', { userName: user.displayName })"
      />
      <ProfilePicture
        :user="user"
        :size="size"
        class="hoverScale"
      />
    </div>

    <div
      v-if="isJoiningOrLeaving(pickup)"
      class="emptySlots"
      style="border-color: black"
      :style="{ width: size + 'px', height: size + 'px' }"
    >
      <QSpinner :size="size - 4" />
    </div>

    <Transition
      appear
      :duration="{ enter: 500, leave: 0 }"
      name="bounce"
    >
      <CurrentUser
        v-if="pickup.isUserMember && !isJoiningOrLeaving(pickup)"
        :size="size"
        :user="currentUser"
        :pickup="pickup"
        class="hoverScale"
        @leave="$emit('leave')"
      />
    </Transition>

    <UserSlot
      v-if="!pickup.isDisabled && !pickup.isFull && !(isJoiningOrLeaving(pickup) && !pickup.isUserMember)"
      :size="size"
      :hover-user="currentUser"
      :show-join="!pickup.isUserMember"
      :class="{hoverScale: !pickup.isUserMember}"
      @join="$emit('join')"
    />

    <EmptySlot
      v-for="n in emptySlots"
      :key="n"
      :size="size"
      v-if="n > 1"
    />

    <div
      v-if="noNotShownEmptySlots > 0"
      class="emptySlots"
      :style="{ width: size + 'px', height: size + 'px' }"
    >
      <div/>
      <span v-if="noNotShownEmptySlots <= 99">+ {{ noNotShownEmptySlots }}</span>
      <span v-if="noNotShownEmptySlots > 99 && !hasUnlimitedPlaces">...</span>
      <span v-if="noNotShownEmptySlots > 99 && hasUnlimitedPlaces">+ âˆž</span>
    </div>
  </div>
</template>

<script>
import ProfilePicture from '@/users/components/ProfilePicture'
import UserSlot from './UserSlot'
import EmptySlot from './EmptySlot'
import CurrentUser from './CurrentUser'
import { mapGetters } from 'vuex'
import { QSpinner, QResizeObservable } from 'quasar'

export default {
  props: {
    pickup: {
      type: Object,
      required: true,
    },
    size: {
      type: Number,
      default: 36,
    },
    maxEmptyNumToShow: {
      type: Number,
      default: 1,
    },
  },
  data () {
    return {
      slotsPerRow: 6,
    }
  },
  components: {
    ProfilePicture, UserSlot, EmptySlot, CurrentUser, QSpinner, QResizeObservable,
  },
  methods: {
    isJoiningOrLeaving (pickup) {
      return pickup.joinStatus.pending || pickup.leaveStatus.pending
    },
    calculateSlotsPerRow () {
      if (this.$refs.wrapperDiv) {
        this.slotsPerRow = Math.floor(this.$refs.wrapperDiv.clientWidth / (this.size + 3.8))
      }
    },
    isNewcomer (user) {
      return user.membership && !user.membership.isEditor
    },
  },
  computed: {
    ...mapGetters({
      currentUser: 'auth/user',
    }),
    hasUnlimitedPlaces () {
      return this.pickup.maxCollectors === null
    },
    emptyPlaces () {
      if (this.hasUnlimitedPlaces) {
        return 9999999999
      }
      if (this.pickup.collectors) {
        return Math.max(this.pickup.maxCollectors - this.pickup.collectors.length, 0)
      }
      return 0
    },
    emptySlots () {
      if (this.pickup.collectors) {
        const minToShow = Math.min(this.maxEmptyNumToShow, this.emptyPlaces)
        const maxToShow = Math.max(minToShow, this.slotsPerRow - this.pickup.collectors.length - 1)
        return Math.min(this.emptyPlaces, maxToShow)
      }
      return 0
    },
    noNotShownEmptySlots () {
      return this.emptyPlaces - this.emptySlots
    },
  },
}
</script>

<style scoped lang="stylus">
@import '~variables'
.pic-wrapper
  margin-right 3px
.newcomer-box
  height 8px
  width 100%
  position absolute
  bottom -4px
  left 0
  background linear-gradient(to bottom, $secondary, lighten($secondary, 50))
.emptySlots
  display inline-block
  background-color rgba(255, 255, 255, 0.7)
  border 2px dashed lightgrey
  color grey
  border-radius $borderRadius
  margin-bottom 3.8px
  text-align center
  div
    display inline-block
    height 100%
    vertical-align middle

.bounce-enter-active
  animation bounceIn .4s

.bounce-leave-active
  display none

@keyframes bounceIn{
  0% {
    opacity: 0;
    transform: scale(0.3) translate3d(0,0,0);
  }
  60%{
    opacity: 0.9;
    transform: scale(1.1);
  }
  80%{
    opacity: 1;
    transform: scale(0.89);
  }
  100%{
    opacity: 1;
    transform: scale(1) translate3d(0,0,0);
  }
}
</style>
