<template>
  <div class="list-wrapper">
    <QList>
      <QItem
        v-if="users.length > 1"
        v-t="{ path: 'GROUP.MEMBERLIST', args: { total: users.length } }"
        class="text-caption"
      />
      <QItem
        v-if="users.length > 15"
      >
        <QInput
          v-model="filterTerm"
          :placeholder="$t('BUTTON.SEARCH')"
          class="full-width"
        >
          <template #prepend>
            <QIcon name="search" />
          </template>
        </QInput>
      </QItem>
      <UserItem
        v-for="user in activeUsers"
        :key="user.id"
        :user="user"
      />
      <QSeparator />
      <QExpansionItem
        v-if="inactiveUsers.length > 0"
        @show="showInactive = true"
        @hide="showInactive = false"
      >
        <template #header>
          <QItemSection side>
            <QIcon
              name="fas fa-bed"
              class="q-mr-xs"
            />
          </QItemSection>
          <QItemSection>
            <QItemLabel>
              {{ $t('GROUP.INACTIVE') }}
            </QItemLabel>
            <QItemLabel caption>
              {{ inactiveSublabel }}
            </QItemLabel>
          </QItemSection>
          <QItemSection side>
            <QBtn
              flat
              round
              dense
              icon="help_outline"
              @click.stop="inactivityInfo"
            />
          </QItemSection>
        </template>

        <template v-if="showInactive">
          <UserItem
            v-for="user in inactiveUsers"
            :key="user.id"
            :user="user"
            class="inactive"
          />
        </template>
      </QExpansionItem>
    </QList>
  </div>
</template>

<script>
import {
  Dialog,
  QList,
  QSeparator,
  QItem,
  QItemSection,
  QItemLabel,
  QExpansionItem,
  QBtn,
  QInput,
  QIcon,
} from 'quasar'

import UserItem from './UserItem'
import { useCurrentGroupService } from '@/group/services'

export default {
  components: {
    UserItem,
    QList,
    QSeparator,
    QItem,
    QItemSection,
    QItemLabel,
    QExpansionItem,
    QBtn,
    QInput,
    QIcon,
  },
  props: {
    users: {
      type: Array,
      required: true,
    },
    sorting: {
      type: String,
      default: 'joinDate',
    },
  },
  setup () {
    const {
      group,
      getMembership,
    } = useCurrentGroupService()
    return {
      group,
      getMembership,
    }
  },
  data () {
    return {
      showInactive: false,
      filterTerm: '',
    }
  },
  computed: {
    inactiveSublabel () {
      return this.inactiveUsers.length + ' ' + this.$tc('JOINGROUP.NUM_MEMBERS', this.inactiveUsers.length)
    },
    activeUsers () {
      return this.sort(this.filterByTerms(this.users.filter(u => this.getMembership(u.id).active)))
    },
    inactiveUsers () {
      return this.sort(this.filterByTerms(this.users.filter(u => !this.getMembership(u.id).active)))
    },
  },
  methods: {
    sort (list) {
      const getJoinDate = a => this.getMembership(a.id).createdAt
      const sortByJoinDate = (a, b) => getJoinDate(b) - getJoinDate(a)
      const sortByName = (a, b) => a.displayName.localeCompare(b.displayName)
      return list.slice().sort(this.sorting === 'joinDate' ? sortByJoinDate : sortByName)
    },
    filterByTerms (list) {
      if (!this.filterTerm || this.filterTerm === '') return list
      return list.filter(u => u.displayName.toLowerCase().includes(this.filterTerm.toLowerCase()))
    },
    inactivityInfo () {
      Dialog.create({
        title: this.$t('INACTIVITY.WHAT'),
        message: this.$t('INACTIVITY.HELP', { dayCount: this.group.memberInactiveAfterDays }),
        ok: this.$t('BUTTON.CLOSE'),
      })
    },
  },
}
</script>

<style scoped lang="sass">
.list-wrapper
  .profilePic
    margin-right: .5em

.inactive
  opacity: 0.5
</style>
